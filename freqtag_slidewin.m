 % Function definition function [trialpow,winmat3d,phasestabmat,trialSNR] = freqtag_slidewin(data, plotflag, bslvec, ssvepvec, foi, sampnew, SampRate, outname)  % translate ssvepvec into new sample rate. the sample vector is indicated in old sample rate above  ssvepvec = floor(ssvepvec .* (sampnew./SampRate));   % this to be done outside the loop to save time, needed for winshift proc sampcycle=1000/sampnew; %added code for the new samplerate tempvec = round((1000/foi)/sampcycle); % this makes sure that average win duration is exactly the duration in sp of one cyle at foi longvec = repmat(tempvec,1,100); % repeat this many times, at least for duration of entire epoch, subsegments are created later  winshiftvec_long = [ssvepvec(1) cumsum(longvec)+ ssvepvec(1)]; % use cumsum function to create growing vector of indices for start of the winshift tempindexvec = find(winshiftvec_long > ssvepvec(end)); % find the last possible window onset  endindex = tempindexvec(1);  % this is the first index for which the winshiftvector exceeds the data segment  winshiftvec = winshiftvec_long(1:endindex-5); % need this stuff for the spectrum shiftcycle=round(tempvec*4); samp=1000/sampnew;        freqres = 1000/(shiftcycle*samp); %added code to find the appropriate bin for the frequency of interest for each segment        freqbins = 0:freqres:(sampnew/2);         min_diff_vec = freqbins-foi;          min_diff_vec = abs(min_diff_vec);         targetbin=find(min_diff_vec==min(min_diff_vec));       trialpow = [];     trialSNR = [];     phasestabmat = [];          NTrials = size(data,3);         disp('Trial number:')  for trial = 1:NTrials                Data = squeeze(data(:, :, trial));                fouriersum = [];                 disp(trial)  %===========================================================    % 1. resample data%===========================================================               Data=double(Data'); % make sure data are double precision in case they come from eeglab                    resampled=resample(Data,sampnew,SampRate);                               Data = resampled';      %===========================================================	% 2. Baseline correction%===========================================================	    datamat = bslcorr(Data, bslvec);%==========================================================	% 3. moving window procedure with 4 cycles  !!!%===========================================================		winmatsum = zeros(size(datamat,1),shiftcycle); %4 cycles		 if plotflag, h = figure; end        for winshiftstep = 1:length(winshiftvec), 		        winmatsum = (winmatsum + freqtag_regressionMAT(datamat(:,[winshiftvec(winshiftstep):winshiftvec(winshiftstep)+(shiftcycle-1)]))); % time domain averaging for win file                %for within-trial phase locking        fouriermat = fft(freqtag_regressionMAT(datamat(:,[winshiftvec(winshiftstep):winshiftvec(winshiftstep)+(shiftcycle-1)]))');        fouriercomp = fouriermat(targetbin,:)';                 if winshiftstep ==1            fouriersum = fouriercomp./abs(fouriercomp);        else            fouriersum = fouriersum + fouriercomp./abs(fouriercomp);        end               if plotflag           subplot(2,1,1), plot(1:sampcycle:shiftcycle*sampcycle, freqtag_regressionMAT(datamat(:,[winshiftvec(winshiftstep):winshiftvec(winshiftstep)+(shiftcycle-1)]))'), title(['sliding window starting at ' num2str((winshiftvec(winshiftstep))*sampcycle)  ' ms ']), xlabel('time in milliseconds')           subplot(2,1,2), plot(1:sampcycle:shiftcycle*sampcycle, winmatsum'), title(['sum of sliding windows; number of shifts:' num2str(winshiftstep) ]), ylabel('microvolts')           pause(.4)       end              end        winmat = winmatsum./length(winshiftvec);	%===========================================================	% 4. determine amplitude and Phase using fft of     % averaged sliding windows (variable winmat)	%=========================================================== 		NFFT = shiftcycle-1; % one cycle in sp of the desired frequency times 4 oscillations (-1)	NumUniquePts = ceil((NFFT+1)/2); 	fftMat = fft (winmat', (shiftcycle-1));  % transpose: channels as columns (fft columnwise)	Mag = abs(fftMat);                                                   % Amplitude berechnen	Mag = Mag*2;   		Mag(1) = Mag(1)/2;                                                    % DC only once in the full spectrum, no need to correct as above. 	if ~rem(NFFT,2)                                                       % same with Nyquist        Mag(length(Mag))=Mag(length(Mag))/2;	end		Mag=Mag/NFFT;                                                                trialpow = [trialpow Mag((targetbin),:)'];        trialSNR = [trialSNR log10(Mag((targetbin),:)'./ mean(Mag(([targetbin-2 targetbin+2]),:))').*10]; % a very crude SNR estimate if someone needs it        % phase stability    phasestabmat = [phasestabmat abs(fouriersum./winshiftstep)];         winmat3d(:, :, trial) = winmat;            end % trials      outmat.fftamp = trialpow;    outmat.phasestabmat = phasestabmat;    outmat.winmat = winmat3d;       eval(['save ' outname '.slidwin.mat outmat -mat']);   fclose('all');